
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Task Manager">
    <meta name="description" content="Hierarchical task manager with time tracking">
    
    <title>Hierarchical Task Manager</title>
    
    <!-- Favicon as data URL -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%232563eb' width='100' height='100' rx='20'/><text x='50' y='70' font-size='60' text-anchor='middle' fill='white'>‚úì</text></svg>">
    
    <!-- Apple Touch Icon -->
    <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 180 180'><rect fill='%232563eb' width='180' height='180' rx='40'/><text x='90' y='130' font-size='100' text-anchor='middle' fill='white'>‚úì</text></svg>">
    
    <link rel="manifest" href="#" id="manifest-placeholder">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // Lucide icons as inline SVG components
        const ChevronRight = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        );

        const ChevronDown = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
        );

        const Plus = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <line x1="12" y1="5" x2="12" y2="19"></line>
                <line x1="5" y1="12" x2="19" y2="12"></line>
            </svg>
        );

        const Trash2 = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
        );

        const Clock = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <circle cx="12" cy="12" r="10"></circle>
                <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
        );

        const Save = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                <polyline points="17 21 17 13 7 13 7 21"></polyline>
                <polyline points="7 3 7 8 15 8"></polyline>
            </svg>
        );

        const Download = ({ size = 24, className = "" }) => (
            <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                <polyline points="7 10 12 15 17 10"></polyline>
                <line x1="12" y1="15" x2="12" y2="3"></line>
            </svg>
        );

        const HierarchicalTaskManager = () => {
            const defaultTasks = [
                {
                    id: 1,
                    text: 'Project Alpha',
                    timeMinutes: 0,
                    level: 0,
                    collapsed: false,
                    children: [
                        {
                            id: 2,
                            text: 'Planning Phase',
                            timeMinutes: 120,
                            level: 1,
                            collapsed: false,
                            children: [
                                { id: 3, text: 'Requirements gathering', timeMinutes: 60, level: 2, collapsed: false, children: [] },
                                { id: 4, text: 'Design mockups', timeMinutes: 60, level: 2, collapsed: false, children: [] }
                            ]
                        },
                        {
                            id: 5,
                            text: 'Development',
                            timeMinutes: 0,
                            level: 1,
                            collapsed: false,
                            children: [
                                { id: 6, text: 'Frontend', timeMinutes: 180, level: 2, collapsed: false, children: [] },
                                { id: 7, text: 'Backend', timeMinutes: 240, level: 2, collapsed: false, children: [] }
                            ]
                        }
                    ]
                }
            ];

            // Check if localStorage is available
            const isLocalStorageAvailable = () => {
                try {
                    const test = '__localStorage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch (e) {
                    return false;
                }
            };

            const hasStorage = isLocalStorageAvailable();

            // Load tasks from localStorage or use defaults
            const loadTasks = () => {
                if (!hasStorage) return defaultTasks;
                try {
                    const saved = localStorage.getItem('hierarchicalTasks');
                    return saved ? JSON.parse(saved) : defaultTasks;
                } catch (e) {
                    return defaultTasks;
                }
            };

            const loadNextId = () => {
                if (!hasStorage) return 8;
                try {
                    const saved = localStorage.getItem('hierarchicalTasksNextId');
                    return saved ? parseInt(saved) : 8;
                } catch (e) {
                    return 8;
                }
            };

            const [tasks, setTasks] = useState(loadTasks);
            const [nextId, setNextId] = useState(loadNextId);
            const [saveNotification, setSaveNotification] = useState(false);
            const [installPrompt, setInstallPrompt] = useState(null);
            const [isInstalled, setIsInstalled] = useState(false);

            // Check if app is installed
            useEffect(() => {
                if (window.matchMedia('(display-mode: standalone)').matches) {
                    setIsInstalled(true);
                }
            }, []);

            // Handle install prompt
            useEffect(() => {
                const handler = (e) => {
                    e.preventDefault();
                    setInstallPrompt(e);
                };
                window.addEventListener('beforeinstallprompt', handler);
                return () => window.removeEventListener('beforeinstallprompt', handler);
            }, []);

            const handleInstall = async () => {
                if (!installPrompt) return;
                installPrompt.prompt();
                const { outcome } = await installPrompt.userChoice;
                if (outcome === 'accepted') {
                    setInstallPrompt(null);
                }
            };

            // Save to localStorage whenever tasks change (only if available)
            useEffect(() => {
                if (!hasStorage) return;
                
                try {
                    localStorage.setItem('hierarchicalTasks', JSON.stringify(tasks));
                    localStorage.setItem('hierarchicalTasksNextId', nextId.toString());
                    
                    // Show save notification
                    setSaveNotification(true);
                    const timer = setTimeout(() => setSaveNotification(false), 2000);
                    return () => clearTimeout(timer);
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                }
            }, [tasks, nextId]);

            // Calculate total time for a task including all subtasks
            const calculateTotalTime = (task) => {
                if (!task || typeof task !== 'object') {
                    console.error('Invalid task in calculateTotalTime');
                    return 0;
                }
                
                const taskTime = typeof task.timeMinutes === 'number' ? task.timeMinutes : 0;
                
                if (!task.children || !Array.isArray(task.children) || task.children.length === 0) {
                    return taskTime;
                }
                
                const childrenTime = task.children.reduce((sum, child) => {
                    return sum + calculateTotalTime(child);
                }, 0);
                
                return taskTime + childrenTime;
            };

            // Format minutes to hours and minutes
            const formatTime = (minutes) => {
                if (minutes === 0) return '0m';
                const hours = Math.floor(minutes / 60);
                const mins = minutes % 60;
                if (hours === 0) return `${mins}m`;
                if (mins === 0) return `${hours}h`;
                return `${hours}h ${mins}m`;
            };

            // Add a new task
            const addTask = (parentTask = null) => {
                // Safety check: ensure parent has valid structure
                if (parentTask && (!parentTask.children || !Array.isArray(parentTask.children))) {
                    console.error('Parent task has invalid children structure');
                    return;
                }

                const newTask = {
                    id: nextId,
                    text: 'New task',
                    timeMinutes: 0,
                    level: parentTask ? parentTask.level + 1 : 0,
                    collapsed: false,
                    children: []
                };
                
                setNextId(prev => prev + 1);

                if (parentTask) {
                    setTasks(prevTasks => {
                        const updated = updateTaskRecursive(prevTasks, parentTask.id, (task) => ({
                            ...task,
                            children: [...(task.children || []), newTask]
                        }));
                        return updated;
                    });
                } else {
                    setTasks(prevTasks => [...prevTasks, newTask]);
                }
            };

            // Update task recursively
            const updateTaskRecursive = (taskArray, taskId, updateFn) => {
                if (!Array.isArray(taskArray)) {
                    console.error('Invalid task array in updateTaskRecursive');
                    return [];
                }
                
                return taskArray.map(task => {
                    if (!task || typeof task !== 'object') {
                        console.error('Invalid task object');
                        return task;
                    }
                    
                    if (task.id === taskId) {
                        return updateFn(task);
                    }
                    
                    if (task.children && Array.isArray(task.children) && task.children.length > 0) {
                        return {
                            ...task,
                            children: updateTaskRecursive(task.children, taskId, updateFn)
                        };
                    }
                    
                    return task;
                });
            };

            // Delete task recursively (helper function)
            const deleteTaskRecursive = (taskArray, taskId) => {
                if (!Array.isArray(taskArray)) {
                    console.error('Invalid task array in deleteTaskRecursive');
                    return [];
                }
                
                return taskArray.filter(task => task && task.id !== taskId).map(task => {
                    if (!task || typeof task !== 'object') {
                        return task;
                    }
                    
                    return {
                        ...task,
                        children: task.children && Array.isArray(task.children) && task.children.length > 0
                            ? deleteTaskRecursive(task.children, taskId)
                            : []
                    };
                });
            };

            // Delete task (main function)
            const deleteTask = (taskId) => {
                setTasks(prevTasks => deleteTaskRecursive(prevTasks, taskId));
            };

            // Update task text
            const updateTaskText = (taskId, newText) => {
                setTasks(prevTasks => updateTaskRecursive(prevTasks, taskId, (task) => ({
                    ...task,
                    text: newText
                })));
            };

            // Update task time
            const updateTaskTime = (taskId, minutes) => {
                setTasks(prevTasks => updateTaskRecursive(prevTasks, taskId, (task) => ({
                    ...task,
                    timeMinutes: Math.max(0, parseInt(minutes) || 0)
                })));
            };

            // Toggle collapse
            const toggleCollapse = (taskId) => {
                setTasks(prevTasks => updateTaskRecursive(prevTasks, taskId, (task) => ({
                    ...task,
                    collapsed: !task.collapsed
                })));
            };

            // Clear all data
            const clearAllData = () => {
                if (confirm('Are you sure you want to delete all tasks? This cannot be undone.')) {
                    setTasks([]);
                    setNextId(1);
                    if (hasStorage) {
                        try {
                            localStorage.removeItem('hierarchicalTasks');
                            localStorage.removeItem('hierarchicalTasksNextId');
                        } catch (e) {
                            console.error('Failed to clear localStorage:', e);
                        }
                    }
                }
            };

            // Render a single task
            const renderTask = (task, depth = 0) => {
                // Safety check: ensure task is valid
                if (!task || typeof task !== 'object' || typeof task.id === 'undefined') {
                    console.error('Invalid task in renderTask:', task);
                    return null;
                }
                
                const totalTime = calculateTotalTime(task);
                const hasChildren = task.children && Array.isArray(task.children) && task.children.length > 0;
                const indent = depth * 24;

                return (
                    <div key={task.id} className="mb-1">
                        <div 
                            className="flex items-center gap-2 py-2 px-3 hover:bg-gray-50 rounded group"
                            style={{ marginLeft: `${indent}px` }}
                        >
                            {/* Collapse toggle */}
                            <button
                                onClick={() => toggleCollapse(task.id)}
                                className="w-5 h-5 flex items-center justify-center text-gray-400 hover:text-gray-600"
                                disabled={!hasChildren}
                            >
                                {hasChildren ? (
                                    task.collapsed ? <ChevronRight size={16} /> : <ChevronDown size={16} />
                                ) : (
                                    <div className="w-4 h-4" />
                                )}
                            </button>

                            {/* Task text input */}
                            <input
                                type="text"
                                value={task.text}
                                onChange={(e) => updateTaskText(task.id, e.target.value)}
                                className="flex-1 px-2 py-1 border border-transparent hover:border-gray-300 focus:border-blue-500 focus:outline-none rounded"
                            />

                            {/* Time input */}
                            <div className="flex items-center gap-1">
                                <Clock size={14} className="text-gray-400" />
                                <input
                                    type="number"
                                    value={task.timeMinutes}
                                    onChange={(e) => updateTaskTime(task.id, e.target.value)}
                                    className="w-16 px-2 py-1 border border-gray-300 hover:border-gray-400 focus:border-blue-500 focus:outline-none rounded text-sm"
                                    min="0"
                                    placeholder="0"
                                />
                                <span className="text-sm text-gray-500">m</span>
                            </div>

                            {/* Total time display */}
                            {hasChildren && (
                                <div className="px-2 py-1 bg-blue-50 text-blue-700 rounded text-sm font-medium">
                                    Total: {formatTime(totalTime)}
                                </div>
                            )}

                            {/* Actions */}
                            <div className="flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                                <button
                                    onClick={() => addTask(task)}
                                    className="p-1 hover:bg-blue-100 text-blue-600 rounded"
                                    title="Add subtask"
                                    disabled={depth >= 5}
                                >
                                    <Plus size={16} />
                                </button>
                                <button
                                    onClick={() => deleteTask(task.id)}
                                    className="p-1 hover:bg-red-100 text-red-600 rounded"
                                    title="Delete task"
                                >
                                    <Trash2 size={16} />
                                </button>
                            </div>
                        </div>

                        {/* Render children */}
                        {hasChildren && !task.collapsed && depth < 10 && (
                            <div>
                                {task.children
                                    .filter(child => child && typeof child === 'object' && typeof child.id !== 'undefined')
                                    .map(child => renderTask(child, depth + 1))}
                            </div>
                        )}
                    </div>
                );
            };

            // Calculate total project time
            const totalProjectTime = Array.isArray(tasks) 
                ? tasks.reduce((sum, task) => sum + calculateTotalTime(task), 0)
                : 0;

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-50 p-6">
                    {/* Save notification */}
                    {saveNotification && hasStorage && (
                        <div className="fixed top-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 animate-fade-in z-50">
                            <Save size={16} />
                            <span>Saved automatically</span>
                        </div>
                    )}

                    {/* Storage warning */}
                    {!hasStorage && (
                        <div className="fixed top-4 right-4 bg-yellow-500 text-white px-4 py-2 rounded-lg shadow-lg flex items-center gap-2 z-50">
                            <span className="text-sm">‚ö†Ô∏è Auto-save disabled (download to enable)</span>
                        </div>
                    )}

                    {/* Install prompt for PWA */}
                    {installPrompt && !isInstalled && (
                        <div className="fixed bottom-4 left-4 right-4 md:left-auto md:right-4 md:w-96 bg-blue-600 text-white p-4 rounded-lg shadow-2xl flex items-center gap-3 z-50 animate-slide-up">
                            <Download size={24} />
                            <div className="flex-1">
                                <div className="font-semibold">Install Task Manager</div>
                                <div className="text-sm text-blue-100">Add to your home screen for quick access</div>
                            </div>
                            <button
                                onClick={handleInstall}
                                className="px-4 py-2 bg-white text-blue-600 rounded font-semibold hover:bg-blue-50 transition-colors"
                            >
                                Install
                            </button>
                            <button
                                onClick={() => setInstallPrompt(null)}
                                className="text-blue-100 hover:text-white"
                            >
                                ‚úï
                            </button>
                        </div>
                    )}

                    {/* Installed badge */}
                    {isInstalled && (
                        <div className="fixed top-4 left-4 bg-green-500 text-white px-3 py-1 rounded-full text-sm font-medium z-50">
                            üì± Installed
                        </div>
                    )}

                    <div className="max-w-5xl mx-auto">
                        {/* Header */}
                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <div className="flex items-center justify-between mb-4">
                                <div>
                                    <h1 className="text-3xl font-bold text-gray-900">Hierarchical Task Manager</h1>
                                    <p className="text-gray-600 mt-1">Organize tasks up to 5 levels deep with automatic time tracking</p>
                                </div>
                                <div className="text-right">
                                    <div className="text-sm text-gray-500">Total Project Time</div>
                                    <div className="text-3xl font-bold text-blue-600">{formatTime(totalProjectTime)}</div>
                                </div>
                            </div>
                            
                            <div className="flex gap-2 flex-wrap">
                                <button
                                    onClick={() => addTask()}
                                    className="flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-colors"
                                >
                                    <Plus size={20} />
                                    Add Top-Level Task
                                </button>
                                
                                <button
                                    onClick={clearAllData}
                                    className="flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-colors"
                                >
                                    <Trash2 size={20} />
                                    Clear All
                                </button>

                                {installPrompt && !isInstalled && (
                                    <button
                                        onClick={handleInstall}
                                        className="flex items-center gap-2 px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-colors"
                                    >
                                        <Download size={20} />
                                        Install App
                                    </button>
                                )}
                            </div>
                        </div>

                        {/* Task list */}
                        <div className="bg-white rounded-lg shadow-lg p-4">
                            {tasks.length === 0 ? (
                                <div className="text-center py-12 text-gray-400">
                                    <p className="text-lg">No tasks yet. Create your first task to get started!</p>
                                </div>
                            ) : (
                                <div>
                                    {tasks
                                        .filter(task => task && typeof task === 'object' && typeof task.id !== 'undefined')
                                        .map(task => renderTask(task, 0))}
                                </div>
                            )}
                        </div>

                        {/* Instructions */}
                        <div className="mt-6 bg-white rounded-lg shadow p-4 text-sm text-gray-600">
                            <h3 className="font-semibold text-gray-900 mb-2">How to use:</h3>
                            <ul className="space-y-1 list-disc list-inside">
                                <li>Click the + button to add subtasks (up to 5 levels deep)</li>
                                <li>Enter time estimates in minutes for each task</li>
                                <li>Parent tasks automatically sum up all subtask times</li>
                                <li>Click the chevron to collapse/expand subtasks</li>
                                <li>Hover over tasks to see action buttons</li>
                                <li><strong>Install as PWA:</strong> On mobile, tap "Add to Home Screen" in Safari (iOS) or "Install" prompt (Android)</li>
                                <li><strong>Desktop:</strong> Look for the install icon in your browser's address bar</li>
                            </ul>
                        </div>
                    </div>
                </div>
            );
        };

        // Render the app
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<HierarchicalTaskManager />);
    </script>

    <script>
        // Register service worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                // Create service worker as a blob
                const swCode = `
                    const CACHE_NAME = 'task-manager-v1';
                    const urlsToCache = [
                        '/',
                    ];

                    self.addEventListener('install', (event) => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then((cache) => cache.addAll(urlsToCache))
                        );
                    });

                    self.addEventListener('fetch', (event) => {
                        event.respondWith(
                            caches.match(event.request)
                                .then((response) => response || fetch(event.request))
                        );
                    });

                    self.addEventListener('activate', (event) => {
                        event.waitUntil(
                            caches.keys().then((cacheNames) => {
                                return Promise.all(
                                    cacheNames.map((cacheName) => {
                                        if (cacheName !== CACHE_NAME) {
                                            return caches.delete(cacheName);
                                        }
                                    })
                                );
                            })
                        );
                    });
                `;

                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);

                navigator.serviceWorker.register(swUrl)
                    .then(reg => console.log('Service Worker registered'))
                    .catch(err => console.log('Service Worker registration failed:', err));
            });
        }

        // Create manifest dynamically
        const manifest = {
            name: "Hierarchical Task Manager",
            short_name: "Tasks",
            description: "Organize tasks with deep nesting and time tracking",
            start_url: window.location.pathname || "/",
            display: "standalone",
            background_color: "#ffffff",
            theme_color: "#2563eb",
            orientation: "any",
            icons: [
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 192 192'><rect fill='%232563eb' width='192' height='192' rx='40'/><path d='M60 100 L85 125 L135 75' stroke='white' stroke-width='12' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>",
                    sizes: "192x192",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                },
                {
                    src: "data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'><rect fill='%232563eb' width='512' height='512' rx='100'/><path d='M160 260 L225 325 L360 190' stroke='white' stroke-width='30' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>",
                    sizes: "512x512",
                    type: "image/svg+xml",
                    purpose: "any maskable"
                }
            ]
        };

        const manifestBlob = new Blob([JSON.stringify(manifest)], { type: 'application/json' });
        const manifestURL = URL.createObjectURL(manifestBlob);
        document.getElementById('manifest-placeholder').setAttribute('href', manifestURL);
    </script>

    <style>
        @keyframes fade-in {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fade-in 0.3s ease-out;
        }
        @keyframes slide-up {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-up {
            animation: slide-up 0.4s ease-out;
        }
    </style>
</body>
</html>
